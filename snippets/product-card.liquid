{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
PRODUCT CARD COMPONENT
----------------------------------------------------------------------------------------------------------------------

This component is used in collection and featured collection to render a single product as a card

********************************************
Supported variables
********************************************

* product: the product to render
* show_rating: show or not the rating. If nothing is set, the theme uses the default product card setting
* show_vendor: show or not the vendor. If nothing is set, the theme uses the default product card setting
* show_quick_buy: show or not the quick buy. If nothing is set, the theme uses the default product card setting
* show_secondary_image: show or not the secondary image. If nothing is set, the theme uses the default product card setting
* show_swatches: allow to force hiding swatches. If nothing is set, it will default to the default card strategy
* stacked: indicate if the product is in stack mode
* reveal: if set to true the item will be revealed in a stacked mode
* background: the background to use for the product card (if none is passed then the one from the global setting is used)
* text_color: the text color to use for the product card (if none is passed then the one from the global setting is used)
* text_alignment: can be "center". If nothing is set, the theme uses the default product card setting
{%- endcomment -%}

{%- assign show_rating = show_rating | default: settings.show_product_rating, allow_false: true -%}
{%- assign show_vendor = show_vendor | default: settings.show_vendor, allow_false: true -%}
{%- assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true -%}
{%- assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true -%}
{%- assign text_alignment = text_alignment | default: settings.product_info_alignment -%}

{%- if stacked and section.settings.products_per_row_mobile == '2' -%}
  {%- assign mobile_reduced = true -%}
{%- endif -%}

{%- assign section_background = section.settings.background_gradient | default: section.settings.background | default: settings.background -%}
{%- assign card_background = background | default: settings.product_card_background -%}
{%- assign card_text_color = text_color | default: settings.product_card_text_color -%}

{%- if section_background != 'rgba(0,0,0,0)' and card_background != 'rgba(0,0,0,0)' and section_background != card_background -%}
  {%- assign card_class = 'product-card ' -%}
{%- else -%}
  {%- assign card_class = 'product-card product-card--blends ' -%}
{%- endif -%}

{%- if show_secondary_image and product.media.size > 1 -%}
  {%- assign card_class = card_class | append: 'product-card--show-secondary-media' -%}
{%- endif -%}

<product-card
  handle="{{ product.handle | escape }}"
  {% if reveal %}reveal-js{% endif %}
  {% render 'surface', class: card_class, background: card_background, text_color: card_text_color %}>
  {%- comment -%}
  --------------------------------------------------------------------------------------------------------------------
  PRODUCT BADGES
  --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}{%- if show_badges and product.media.size > 0 -%}
    {%- render 'product-badges', product: product, class: 'product-card__badge-list' -%}
  {%- endif -%}

  {%- comment -%}
  --------------------------------------------------------------------------------------------------------------------
  PRODUCT MEDIA
  --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}

  {%- if product.media.size > 0 -%}
    <div class="product-card__figure">
      <a href="{{ product.url }}" data-instant>
        {%- capture sizes -%}
          {%- if stacked -%}
            (max-width: 699px) calc(100vw / {{ section.settings.products_per_row_mobile }} - 40px), (max-width: 1200px) calc(100vw / {{ 3 | at_most: section.settings.products_per_row_desktop }} - 64px), calc(min(100vw - 96px, {{ settings.page_width }}px) / {{ section.settings.products_per_row_desktop }} - (24px / {{ section.settings.products_per_row_desktop }} * {{ section.settings.products_per_row_desktop | minus: 1 }}))
          {%- else -%}
            (max-width: 699px) 74vw, (max-width: 999px) 38vw, calc(min(100vw - 96px, {{ settings.page_width }}px) / {{ section.settings.products_per_row_desktop }} - (24px / {{ section.settings.products_per_row_desktop }} * {{ section.settings.products_per_row_desktop | minus: 1 }}))
          {%- endif -%}
        {%- endcapture -%}

        {%- capture main_image_classes -%}product-card__image product-card__image--primary
          {% if settings.product_image_aspect_ratio contains 'crop' %}object-fill-safe{% endif %}
          aspect-{{ settings.product_image_aspect_ratio | split: '_' | first }}{%- endcapture -%}
        {{- product.featured_media | image_url: width: product.featured_media.width | image_tag: loading: 'lazy', sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800', class: main_image_classes -}}

        {%- if show_secondary_image and product.media.size > 1 -%}
          {%- assign next_media = product.media[product.featured_media.position] | default: product.media[1] -%}
          {{- next_media | image_url: width: next_media.width | image_tag: class: 'product-card__image product-card__image--secondary object-fill', loading: 'lazy', fetchpriority: 'low', sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800' -}}
        {%- endif -%}
      </a>

      {%- if show_quick_buy and product.available -%}
        <div class="product-card__quick-buy">
          {%- assign quick_add_label = 'product.general.quick_add' | t -%}

          {%- if product.variants.size == 1 and product.selling_plan_groups.size == 0 -%}
            {%- form 'product', product, is: 'product-form' -%}
              <input
                type="hidden"
                name="id"
                value="{{ product.selected_or_first_available_variant.id }}">

              <div class="pointer-fine:hidden">
                <button
                  type="submit"
                  is="custom-button"
                  class="product-card__mobile-quick-buy-button"
                  aria-label="{{ quick_add_label | escape }}">
                  {%- render 'icon' with 'quick-buy-cart' -%}
                </button>
              </div>

              <div class="pointer-coarse:hidden">
                {%- render 'button', type: 'submit', content: quick_add_label -%}
              </div>
            {%- endform -%}
          {%- else -%}
            {%- capture quick_buy_id -%}quick-buy-{{ section.id }}-{{ product.id }}{%- endcapture -%}

            <div class="pointer-fine:hidden">
              <button
                type="button"
                aria-controls="{{ quick_buy_id }}"
                aria-expanded="false"
                aria-label="{{ quick_add_label | escape }}"
                is="custom-button"
                class="product-card__mobile-quick-buy-button">
                {%- render 'icon' with 'quick-buy-cart' -%}
              </button>
            </div>

            <div class="pointer-coarse:hidden">
              {%- render 'button', content: quick_add_label, aria_controls: quick_buy_id -%}
            </div>

            <quick-buy-drawer
              id="{{ quick_buy_id }}"
              header-bordered
              open-from="bottom"
              handle="{{ product.handle }}"
              role="region"
              aria-live="polite"
              class="quick-buy-drawer drawer">{%- comment -%}Quick buy content is filled on demand for performance reasons {%- endcomment -%}
            </quick-buy-drawer>
          {%- endif -%}
        </div>
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- comment -%}
  --------------------------------------------------------------------------------------------------------------------
  PRODUCT INFO
  --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}

  <div class="product-card__info  {% if text_alignment == 'center' %}product-card__info--center{% endif %}">
    {%  if product.metafields.custom.productcardtagtext  != blank %}
      <div class="cardtagtext">{{ product.metafields.custom.productcardtagtext }}</div>
    {%  endif %}
    {%- if show_vendor and product.vendor != blank -%}
      {%- if show_rating and text_alignment != 'center' -%}
        <div class="rating-with-text w-full">
          {%- render 'vendor' with product.vendor, class: 'text-xs' -%}

          {%- capture rating_class -%}
            {% if mobile_reduced %}hidden sm:flex{% endif %}
          {%- endcapture -%}
          {%- render 'product-rating', product: product, class: rating_class, display_mode: settings.product_rating_mode -%}
        </div>
      {%- else -%}
        {%- render 'vendor' with product.vendor, class: 'text-xs' -%}
      {%- endif -%}
    {%- endif -%}
  
    <div class="v-stack gap-0.5 w-full {% if text_alignment == 'center' %}justify-items-center{% endif %}">
      {%- if show_rating and show_vendor == false or product.vendor == blank -%}
        <div class="rating-with-text">
          <span class="product-card__title">
            <a
              href="{{ product.url }}"
              class="bold"
              data-instant>{{ product.title }}</a>
          </span>

          {%- render 'price-list', product: product, text_alignment: text_alignment -%}

          {% comment %}  
          {%- if text_alignment != 'center' -%}
          {%- capture rating_class -%}
          {% if mobile_reduced %}hidden sm:flex{% endif %}
          {%- endcapture -%}
          {%- render 'product-rating', product: product, class: rating_class, display_mode: settings.product_rating_mode -%}
          {%- endif -%}
          {% endcomment %}
        </div>
      {%- else -%}
        <span class="product-card__title">
          <a
            href="{{ product.url }}"
            class="bold"
            data-instant>{{ product.title }}</a>
        </span>
      {%- endif -%}

      {% comment %}
      {%- render 'price-list', product: product, text_alignment: text_alignment -%} 
      {% endcomment %}

    </div>


    {%- if show_rating and mobile_reduced or text_alignment == 'center' -%}
      {%- capture rating_class -%}
        {% unless text_alignment == 'center' %}sm:hidden{% endunless %}
      {%- endcapture -%}
      {%- render 'product-rating', product: product, class: rating_class, display_mode: settings.product_rating_mode -%}
    {%- endif -%}

    {% comment %}
    Start info code
    {% endcomment %}


    {% comment %}
    end info code
    {% endcomment %}
    {%- if settings.product_color_display != 'hide' and show_swatches != false -%}
      {%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}

      {%- for color_label in color_label_list -%}
        {%- if product.options_by_name[color_label] != blank -%}
          {%- assign product_option = product.options_by_name[color_label] -%}
          {%- capture name -%}swatch-{{ section.id }}-{{ product.id }}-{{ product_option.position }}{%- endcapture -%}

          <div class="product-card__aside">
            {%- case settings.product_color_display -%}
              {%- when 'count' -%}
              <p class="product-card__color-count text-sm text-subdued">{{- 'product.general.available_colors_count' | t: count: product_option.values.size -}}</p>

              {%- when 'swatch' -%}
              <fieldset class="product-card__swatch-list h-stack {% if settings.color_swatch_style == 'rectangle' %}gap-2.5{% else %}gap-0.5{% endif %}" data-option-position="{{ product_option.position }}">
                {%- for option_value in product_option.values limit: 4 -%}
                  {%- if forloop.first or product.selected_or_first_available_variant.matched and option_value == product_option.selected_value -%}
                    {%- assign selected = true -%}
                  {%- else -%}
                    {% assign selected = false %}
                  {%- endif -%}

                  {%- render 'swatch' with 'color', value: option_value, name: name, size: 'sm', selected: selected -%}
                {%- endfor -%}

                {% if product_option.values.size > 4 %}
                  <a
                    href="{{ product.url }}"
                    data-instant
                    class="color-swatch__view-more {% if settings.color_swatch_style == 'round' %}rounded-full{% endif %} text-xxs text-subdued">+{{ product_option.values.size | minus: 4 }}</a>
                {% endif %}
              </fieldset>

              {%- when 'variant' -%}
              <fieldset class="product-card__variant-list" data-option-position="{{ product_option.position }}">
                {%- for option_value in product_option.values limit: 4 -%}
                  {%- assign variant_option = 'option' | append: product_option.position -%}
                  {%- assign variant_for_value = product.variants | where: variant_option, option_value | first -%}

                  {%- if forloop.first or variant_for_value.matched and option_value == product_option.selected_value -%}
                    {%- assign selected = true -%}
                  {%- else -%}
                    {% assign selected = false %}
                  {%- endif -%}

                  {%- render 'swatch' with 'media', media: variant_for_value.featured_media, value: option_value, name: name, size: 'sm', selected: selected -%}
                {%- endfor -%}

                {%- if product_option.values.size > 4 -%}
                  <a
                    href="{{ product.url }}"
                    data-instant
                    class="media-swatch__view-more text-xs text-subdued">+{{ product_option.values.size | minus: 4 }}</a>
                {%- endif -%}
              </fieldset>
            {%- endcase -%}
          </div>

          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
    <div>{{ product.description |truncate: 80  }}</div>
      <div class="product-info__buy-buttons cardadtc" {{ block.shopify_attributes }} >
        {%- capture product_form_id -%}product-form-{{ product.id }}-{{ section.id }}{%- endcapture -%}
        
{%- assign variant_picker_block = section.blocks | where: 'type', 'variant_picker' | first -%}

{%- form 'product', product, is: 'product-form', id: form_id -%}
  <input type="hidden" {% if variant_picker_block != blank %}disabled{% endif %} name="id" value="{{ product.selected_or_first_available_variant.id }}">

  {%- assign button_disabled = false -%}
  {%- assign button_size = button_size | default: 'xl' -%}

  {%- if product.selected_or_first_available_variant.available -%}
    {%- if product.template_suffix contains 'pre-order' -%}
      {%- capture button_content -%}{{ 'product.general.pre_order_button' | t }}{%- endcapture -%}
    {%- else -%}
      {%- capture button_content -%}{{ 'product.general.add_to_cart_button' | t }}{%- endcapture -%}
    {%- endif -%}
  {%- else -%}
    {%- capture button_content -%}{{ 'product.general.sold_out_button' | t }}{%- endcapture -%}
    {%- assign button_disabled = true -%}
  {%- endif -%}

  <buy-buttons class="buy-buttons {% if show_payment_button %}buy-buttons--multiple{% endif %}" template="{{ product.template_suffix | escape }}" form="{{ form_id }}">
<!--     {%- render 'button', content: button_content, type: 'submit', size: button_size, disabled: button_disabled, secondary: show_payment_button, subdued: button_disabled, background: atc_button_background, text_color: atc_button_text_color -%} -->

{% liquid
  assign style = style | default: settings.button_style

  capture class_attribute
    echo 'button'

    if size != blank and size != 'base'
      echo ' button--' | append: size
    endif

    if style == 'outline'
      echo ' button--outline'
    endif

    if secondary and disabled != true
      echo ' button--secondary'
    endif

    if subdued and background == blank and text_color == blank
      echo ' button--subdued'
    endif

    if stretch
      echo ' w-full'
    endif
  endcapture
%}

{%- capture style_attribute -%}
  {%- if background != blank and background != 'rgba(0,0,0,0)' -%}
    --button-background: {{ background.rgb }} / var(--button-background-opacity, 1);

    {%- if style != 'outline' -%}
      --button-outline-color: {{ background.rgb }};
    {%- endif -%}
  {%- endif -%}

  {%- if text_color != blank and text_color != 'rgba(0,0,0,0)' -%}
    --button-text-color: {{ text_color.rgb }};

    {%- if style == 'outline' -%}
      --button-outline-color: {{ text_color.rgb }};
    {%- endif -%}
  {%- endif -%}
{%- endcapture -%}

{%- capture attributes -%}
  {% if class_attribute != blank %}class="{{ class_attribute | strip_newlines | strip }}"{% endif %}
  {% if style_attribute != blank %}style="{{ style_attribute | strip_newlines | strip }}"{% endif %}
  {% if aria_controls %}aria-controls="{{ aria_controls }}" aria-expanded="false"{% endif %}
  {% if disabled %}{% if href %}role="link" aria-disabled="true"{% else %}disabled{% endif %}{% endif %}
  {% if name %}name="{{ name }}"{% endif %}
  {% if form %}form="{{ form }}"{% endif %}
  {% if href %}href="{{ href }}"{% endif %}
  {% if external and href != blank %}target="_blank"{% endif %}
  {% if href == blank %}is="{{ is | default: 'custom-button' }}"{% endif %}
{%- endcapture -%}

{%- capture button_content -%}
  {% if icon != blank %}
    <div class="text-with-icon justify-center">
      {%- render 'icon' with icon, width: 18, height: 18 -%}
      {{- content -}}
    </div>
  {%- else -%}
    {{- content -}}
  {%- endif -%}
{%- endcapture -%}

{%- if href != blank -%}
  <a {{ attributes }} {{ block.shopify_attributes }}>
    {{- button_content -}}
  </a>
{%- else -%}
  <button type="{{ type | default: 'button' }}" {{ attributes }} {{ block.shopify_attributes }}>
    {{- button_content -}}{{- product.compare_at_price_min -}}
  </button>
{%- endif -%}
    {%- if show_payment_button -%}
      {{- form | payment_button -}}

      <style>
        #shopify-section-{{ section.id }} .shopify-payment-button {
        {%- unless product.selected_or_first_available_variant.available -%}
          display: none;
        {%- endunless -%}

        {%- if payment_button_background != blank and payment_button_background != 'rgba(0,0,0,0)' -%}
          --button-background: {{ payment_button_background.rgb }};
        {%- endif -%}

        {%- if payment_button_text_color != blank and payment_button_text_color != 'rgba(0,0,0,0)' -%}
          --button-text-color: {{ payment_button_text_color.rgb }};
        {%- endif -%}
        }
      </style>
    {%- endif -%}
  </buy-buttons>
{%- endform -%}
<!--         {%- render 'buy-buttons', product: product, form_id: product_form_id, show_payment_button: block.settings.show_payment_button, atc_button_background: block.settings.atc_button_background, atc_button_text_color: block.settings.atc_button_text_color, payment_button_background: block.settings.payment_button_background, payment_button_text_color: block.settings.payment_button_text_color -%} -->
      </div>
      <div class="metafieldflexcard">
        <div class="textmetafield">
          <div class="iconmargin">{{ product.metafields.custom.productcardicon1 }}</div>
          <div class="metafieldtext">{{ product.metafields.custom.productcardtext1 }}</div>
        </div>
        <div class="textmetafield">
          <div class="iconmargin">{{ product.metafields.custom.productcardicon2 }}</div>
          <div class="metafieldtext">{{ product.metafields.custom.productcardtext2 }}</div>
        </div>
    </div>
  </div>
</product-card>